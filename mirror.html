<!DOCTYPE html>
<html>
<head>

<script type="text/javascript" src="jquery-1.4.2.min.js"></script>
<script src="jquery.vticker.js"></script>
<script src="jcarousellite_1.0.1c4.js" type="text/javascript"></script>
<script>
function TimeDate() {
    	var today = new Date();
    	var h = today.getHours();
    	var m = today.getMinutes();
    	var s = today.getSeconds();
	h = FillwZeros(h);
    	m = FillwZeros(m);
    	s = FillwZeros(s);
    	document.getElementById('clock1').innerHTML = h + ":" + m;

	//display name of day and date
	var nameOfDay;
	switch(today.getDay()){
		case 0:	nameOfDay = "Sonntag";
		break;
		case 1:	nameOfDay = "Montag";
		break;
		case 2:	nameOfDay = "Dienstag";
		break;
		case 3:	nameOfDay = "Mittwoch";
		break;
		case 4:	nameOfDay = "Donnerstag";
		break;
		case 5: nameOfDay = "Freitag";
		break;
		case 6: nameOfDay = "Samstag";
		break;
	}
	document.getElementById("date").innerHTML = nameOfDay + ", " + today.getDate() + "." + (today.getMonth()+1) + "." + today.getFullYear();
}

function FillwZeros(i) {
    if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
    return i;
}

function dateFromString(s) {
  var bits = s.split(/[-T:]/g);
  var d = new Date(bits[0], bits[1]-1, bits[2]);
  d.setHours(bits[3], bits[4], bits[5]);

  return d;
}

function updateWeather() {
	//$.getJSON('https://www.yr.no/place/Germany/Baden-W%C3%BCrttemberg/Ulm/forecast.xml' ,function(data) {
	var request = new XMLHttpRequest();
	request.open("GET", "wetter.php", false);
	request.setRequestHeader("Content-Type", "application/xml");
	request.send({ 'request': "authentication token" });
	var xml = request.responseXML;
	var forecast = xml.getElementsByTagName("time"); 
	var weather;
	var i = 0;
	var today = new Date ();
	for(i = 0; i < 3; i++) {
		var detailedForecast = forecast[i];
		var validFrom = dateFromString(detailedForecast.getAttribute("from"));
		var validTo = dateFromString(detailedForecast.getAttribute("to"));
		var symbol = detailedForecast.getElementsByTagName("symbol");
		var temperature = detailedForecast.getElementsByTagName("temperature");
		
		if( i > 0){
			document.getElementById("time"+i).innerHTML = validFrom.getHours() + "-" + validTo.getHours();
		}
		document.getElementById("imgWeather"+i).setAttribute("src", "yr-weather-symbols/dist/svg/" + symbol[0].getAttribute("var") + ".svg");
		document.getElementById("temperature"+i).innerHTML = temperature[0].getAttribute("value") + " &#x2103";	
		
	}
}

function updateBus(){
	$.getJSON("busverbindung.php", function(data) {
		//document.getElementById("bus0").innerHTML = data.info.stopname;
		if(data.departures.length >= 3){
			for(i = 0; i < 4; i++){
				dep = data.departures[i];
				if (dep.realtime=='1') {
					classRealtime = "realtime";
					stern = "<img class=\"realtime\" src=\"realtime.png\">";
				} else {
					classRealtime = "notrealtime";
					stern = "<img class=\"realtime\" src=\"norealtime.png\">";
				}
				// sometimes, lines are canceled:
				if (dep.delay == "-9999") { // line is canceled
					classCanceled = "canceled";
				} else {
					classCanceled = "";
				}
				// html stuff
				text = '<tr id="liste' + i + '"><td class="busline","'+classCanceled+'">' + dep.line + '</td>';
				text = text + '<td class="' + classCanceled + '">' + dep.direction + '</td>';

			
				if (dep.countdown < 20) {
					text = text + '<td class="'+classRealtime+' '+classCanceled+'">' + dep.countdown  + stern+'</td>';
				} else {
					text = text + '<td class="'+classRealtime+' '+classCanceled+'">' + dep.timetable  +  stern+'</td>';
				}
				text = text + '</tr>';
				// switch seamless: delete the old, insert the new one
				$('#liste'+i).remove();
				$('#busconnections').before(text);
			}	
		}
	}); 
}

function updatePostillonNews(){
	$.getJSON("postillonFeed.php", function (data) {
		//get number of different tickers
		var numberOfTicker = data.newsTicker.length;
		var pick = Math.floor((Math.random() * numberOfTicker));
		document.getElementById("postillon").innerHTML = data.newsTicker[pick];
	
	//var t = setTimeout(updatePostillonNews, 10000);
	$("#postillon").jCarouselLite({
		vertical: true, 
		visible: 1,
		auto:3000,
		speed:2000,
		circular: true
	});
	});
}

function initialize(){
	TimeDate();
	updateWeather();
	updateBus();
	updatePostillonNews();
	//var t = setTimeout(refreshAll, 1000);
}
</script>


<title>SmartMirror</title>
<style>
div.clock {
	font-size: 140px;
}
weather {
	text-align: center;
	border-spacing: 25px;
}
image {
		
}
.forecastTable {
	border-left: 1px solid;
	border-right: 1px solid;
}
td {
	padding: 0 10px 0 10px;
}
.temperature0 {
	color: red;
	font-size: 23px;
	font-weigth: bold;	
}

.temperature1 {
	font-weight: bold;
}

.postillon {
	width: 600px;
	margin: 0;
	padding: 0;
}
.postillon ul li{ list-style:none; display:block; padding-bottom:1px; margin-bottom:5px; }

.canceled {
	text-decoration: line-through;
}

.realtime {
	color:#333;
}

img.realtime {
	vertical-align: middle;
	display: inline;
	height: 25px;
	margin-left: 0.2em;
}

.notrealtime {
	text_align: right;
	color:#888;
}

.busline {
	width: 10px;
}


</style>

</head>
<body onload=initialize() style="background-color:black;">
<font color="white">

<div class="page">
	<table>
		<tr>
			<td text-align=left width=400px>
				<div id=date></div><div class=clock id=clock1>
				</div>
			</td>
			<td>
				<div class=weather id=weather0>
					<div align="center" id=time0>now</div>
					<img class=image id=imgWeather0 height=100px width=100px>
					<div class=temperature0 align="center" id=temperature0></div>
				</div>
			</td>
			<td class=forecastTable>
				<div class=weather id=weather1>
					<div align="center" id=time1></div>
					<img class=image id=imgWeather1 height=100px width=80px>
					<div class=temperature1 align="center" id=temperature1></div>
				</div>
			</td>
			<td>
				<div class=weather id=weather2>
					<div align="center" id=time2></div>
					<img class=image id=imgWeather2 height=100px width=70px>
					<div class=temperature1 align="center" id=temperature2></div>
				</div>
			</td>
		</tr> 
	</table>
	<table>
		<tr>
			<td colspan="2">
				<div>N&auml;chste Busse am Lehrer Tal:</div>
			</td>
		</tr>
		<tr id=busconnections></tr>
	</table>
	<table>
		<tr>
			<td>
				<div class=postillon id=postillon></div>
			</td>
		</tr>
	</table>

</div>

</font>
</body>
</html>


